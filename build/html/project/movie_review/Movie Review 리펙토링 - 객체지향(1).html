
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Review 리펙토링 - 객체지향 &#8212; Jinpyo&#39;s Blog  documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Jinpyo's Blog  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="문서 검색 ..." aria-label="문서 검색 ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Python:
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../python/walrus_operator.html">
   왈러스 연산자
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../python/max_heap.html">
   heapq로 최대힙 사용하기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../python/%ED%8C%8C%EC%9D%B4%EC%8D%AC%EC%9D%98_%EC%86%8D%EB%8F%84%EA%B0%80_%EB%8A%90%EB%A6%B0_%EC%9D%B4%EC%9C%A0.html">
   파이썬의 속도가 느린 이유
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="탐색 전환" aria-controls="site-navigation"
                title="탐색 전환" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="이 페이지 다운로드"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/project/movie_review/Movie Review 리펙토링 - 객체지향(1).md.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="소스 파일 다운로드" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="PDF로 인쇄"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="전체 화면으로보기"
        title="전체 화면으로보기"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> 내용
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   사전 설명
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     기술 스택
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     프로젝트 설명
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accounts-user">
   Accounts (User 관리)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#models">
     models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#urls">
     urls
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#views">
     views
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#user">
       User 목록 반환, 회원가입
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       프로필 보기, 회원정보 변경, 회원탈퇴
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     정리
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       참고자료
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id7">
       결과
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="movie-review">
<h1>Movie Review 리펙토링 - 객체지향<a class="headerlink" href="#movie-review" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>리펙토링에 사용되는 코드는 제 첫 프로젝트인 <code class="docutils literal notranslate"><span class="pre">영화</span> <span class="pre">커뮤니티</span> <span class="pre">사이트</span></code>입니다.</p>
<p>본 리펙토링 과정은 3 단계로 진행할 예정이며 객체지향, 테스트코드, 아키텍쳐 순으로 진행합니다.</p>
<p>객체지향의 의미를 생각하며 코드 리뷰 및 리펙토링을 진행합니다.</p>
</div></blockquote>
<div class="section" id="id1">
<h2>사전 설명<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>기술 스택<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>해당 프로젝트의 <code class="docutils literal notranslate"><span class="pre">Back-end</span></code> 시스템을 리펙토링 합니다.</p>
<p>사용된 기술은 다음과 같습니다.</p>
<ul class="simple">
<li><p>Django</p></li>
<li><p>Django Rest Framework</p></li>
<li><p>JWT</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>프로젝트 설명<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>영화 데이터를 스크래핑하여 DB에 저장하고 이를 바탕으로 한 커뮤니티 사이트 입니다.</p>
<p>대략적으로 다음과 같은 코드 구조로 이루어져있습니다.</p>
<ol class="arabic simple">
<li><p>유저 데이터 CRUD</p></li>
<li><p>영화 데이터 스크랩</p></li>
<li><p>영화 데이터 CRUD</p></li>
<li><p>영화 평점 CRUD</p></li>
<li><p>영화 댓글 CRUD</p></li>
<li><p>영화 좋아요</p></li>
</ol>
<p>모델과 뷰에 대한 자세한 설명은 리펙토링 과정에서 이루어집니다.</p>
</div>
</div>
<div class="section" id="accounts-user">
<h2>Accounts (User 관리)<a class="headerlink" href="#accounts-user" title="Permalink to this headline">¶</a></h2>
<div class="section" id="models">
<h3>models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># accounts.models</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractUser</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">User</span></code>는 커뮤니티 사용자를 의미합니다.</p>
<p><code class="docutils literal notranslate"><span class="pre">AbstractUser</span></code>에 기본적인 User fields가 존재하기 때문에 User의 field는 다음과 같습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">password</span><span class="p">,</span> <span class="n">last_login</span><span class="p">,</span> <span class="n">is_superuser</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">is_staff</span><span class="p">,</span> <span class="n">is_active</span><span class="p">,</span> <span class="n">date_joined</span><span class="p">,</span> <span class="n">username</span>
</pre></div>
</div>
</div>
<div class="section" id="urls">
<h3>urls<a class="headerlink" href="#urls" title="Permalink to this headline">¶</a></h3>
<p><strong>before</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># accounts.urls</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="kn">from</span> <span class="nn">rest_framework_jwt.views</span> <span class="kn">import</span> <span class="n">obtain_jwt_token</span><span class="p">,</span> <span class="n">refresh_jwt_token</span><span class="p">,</span> <span class="n">verify_jwt_token</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;get-users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">get_users</span><span class="p">),</span>
    
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;signup/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">signup</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;api-token-auth/&#39;</span><span class="p">,</span> <span class="n">obtain_jwt_token</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;token-verify/&#39;</span><span class="p">,</span> <span class="n">refresh_jwt_token</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;token-refresh/&#39;</span><span class="p">,</span> <span class="n">verify_jwt_token</span><span class="p">),</span>

    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;user_update_delete/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">user_update_delete</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;profile/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">profile</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>URI의 상태가 __RESTful__과는 거리가 멀어 수정할 여지가 있습니다.</p>
<ul class="simple">
<li><p>모든 <code class="docutils literal notranslate"><span class="pre">User</span></code>의 목록을 반환: <code class="docutils literal notranslate"><span class="pre">get-users/</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">users/</span></code></p></li>
<li><p>새로운 <code class="docutils literal notranslate"><span class="pre">User</span></code>를 생성(회원가입): <code class="docutils literal notranslate"><span class="pre">signup/</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">users/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">User</span></code> 데이터를 변경 또는 삭제: <code class="docutils literal notranslate"><span class="pre">user_update_delete/</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">PATCH</span> <span class="pre">users/{user_id}</span></code>, <code class="docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">users/{user_id}</span></code></p></li>
<li><p>한 <code class="docutils literal notranslate"><span class="pre">User</span></code>의 데이터를 반환: <code class="docutils literal notranslate"><span class="pre">profile</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">users/{user_id}</span></code></p></li>
</ul>
<p>또한 본 코드에서는 <code class="docutils literal notranslate"><span class="pre">djangorestframework-jwt</span></code>를 이용해 <strong>authorization</strong> 처리를 했으나, 이 라이브러리는 최신버전의 __python, Django, DRF__를 지원하지 않습니다.<a class="reference external" href="https://jpadilla.github.io/django-rest-framework-jwt/">Django REST framework JWT (jpadilla.github.io)</a></p>
<p>![image-20220118213222319](Movie Review 리펙토링 - 객체지향.assets/image-20220118213222319.png)</p>
<p>따라서 <strong>DRF</strong> 공식문서에서 제안하는 <code class="docutils literal notranslate"><span class="pre">djangorestframework-simplejwt</span></code>로 대체합니다. 이 과정은 객체지향적으로 리펙토링하는 본 문서의 목적과 관련이 적으므로 생략합니다.</p>
<p>새로운 URI를 적용한 코드는 다음과 같습니다.</p>
<p><strong>after</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># accounts.urls</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">rest_framework_simplejwt.views</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TokenObtainPairView</span><span class="p">,</span>
    <span class="n">TokenRefreshView</span><span class="p">,</span>
    <span class="n">TokenVerifyView</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;users/&lt;str:username&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>

    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;login/&#39;</span><span class="p">,</span> <span class="n">TokenObtainPairView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;token/refresh/&#39;</span><span class="p">,</span> <span class="n">TokenRefreshView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;token/verify/&#39;</span><span class="p">,</span> <span class="n">TokenVerifyView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>기존 <code class="docutils literal notranslate"><span class="pre">get-users/</span></code>, <code class="docutils literal notranslate"><span class="pre">signup/</span></code>, <code class="docutils literal notranslate"><span class="pre">user_update_delete/</span></code>, <code class="docutils literal notranslate"><span class="pre">profile/</span></code>로 구분된 URI가 <code class="docutils literal notranslate"><span class="pre">users/</span></code>와 <code class="docutils literal notranslate"><span class="pre">users/{user_id}/</span></code>로 응축되었습니다. 또한 자원중심적인 URI로 <strong>RESTful</strong> 에 더 알맞다고 할 수 있습니다.</p>
<p><strong>CBV</strong> 의 이름 <code class="docutils literal notranslate"><span class="pre">UserList</span></code>와 <code class="docutils literal notranslate"><span class="pre">UserDetail</span></code>은 <strong>DRF</strong> 공식 문서에서 사용한 예제를 바탕으로 만든 것으로, 도메인에 맞는 직관적인 이름이 아닐 수 있습니다. <a class="reference external" href="https://www.django-rest-framework.org/tutorial/3-class-based-views/">3 - Class based views - Django REST framework (django-rest-framework.org)</a><br />
좀 더 경험을 쌓고 더 좋은 네이밍을 떠올려 적용해보려고 합니다.</p>
<blockquote>
<div><p><strong>User 대신에 get_user_model()을 사용하는 이유</strong></p>
<p>만약 <code class="docutils literal notranslate"><span class="pre">User</span></code>를 직접 참조하면, <code class="docutils literal notranslate"><span class="pre">settings.AUTH_USER_MODEL</span></code>이 변경되었을 때 변경을 반영할 수 없습니다.</p>
<p>본 프로젝트에서도 <code class="docutils literal notranslate"><span class="pre">settings.AUTH_USER_MODEL</span></code>은 기본값인 <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.models.User</span></code>가 아닌 <code class="docutils literal notranslate"><span class="pre">accounts.models.User</span></code> 를 가리킵니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span>
<span class="go">&lt;class &#39;django.contrib.auth.models.User&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_user_model</span><span class="p">()</span>
<span class="go">&lt;class &#39;accounts.models.User&#39;&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://docs.djangoproject.com/en/4.0/topics/auth/customizing/#referencing-the-user-model">Customizing authentication in Django | Django documentation | Django (djangoproject.com)</a></p>
</div></blockquote>
</div>
<div class="section" id="views">
<h3>views<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h3>
<div class="section" id="user">
<h4>User 목록 반환, 회원가입<a class="headerlink" href="#user" title="Permalink to this headline">¶</a></h4>
<p><strong>before</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># User 목록 반환</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 회원가입</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="c1">#1-1. Client에서 온 데이터를 받아서</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">password_confirmation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passwordConfirmation&#39;</span><span class="p">)</span>
		
	<span class="c1">#1-2. 패스워드 일치 여부 체크</span>
    <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password_confirmation</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
		
	<span class="c1">#2. UserSerializer를 통해 데이터 직렬화</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
	<span class="c1">#3. validation 작업 진행 -&gt; password도 같이 직렬화 진행</span>
    <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1">#4. 비밀번호 해싱 후 </span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># password는 직렬화 과정에는 포함 되지만 → 표현(response)할 때는 나타나지 않는다.</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
</pre></div>
</div>
<p>하나의 객체에서 <strong>GET, POST</strong> 요청을 모두 처리하기 위해 위의 두 함수를 하나의 <strong>CBV(Class Based View)</strong> 로 통합합니다.</p>
<p>이 때 <strong>CBV</strong> 로 작성하는 방법에는 세 가지가 있는데 각각 소개하겠습니다.</p>
<p><strong>after 1 (APIView 사용)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    모든 User 목록을 반환하거나, 새로운 User를 등록할 수 있습니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="n">password_confirmation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passwordConfirmation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password_confirmation</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                           <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
            
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
</pre></div>
</div>
<p>객체 하나에서 <strong>GET, POST</strong> 를 분기하여 처리가 가능합니다.</p>
<p><strong>after 2 (Mixin 사용)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span><span class="p">,</span> <span class="n">generics</span>

<span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
               <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
               <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>GenericAPIView</strong> 를 이용하면 <strong>Mixin</strong> 을 이용해 코드를 간결하게 만들 수 있습니다.</p>
<p>각 <code class="docutils literal notranslate"><span class="pre">Mixin</span></code>의 역할은 다음과 같습니다.</p>
<ul class="simple">
<li><p><strong>ListModelMixin</strong> : <code class="docutils literal notranslate"><span class="pre">get</span></code> 메서드에서 해당 object 전체를 반환합니다.</p></li>
<li><p><strong>CreateModelMixin</strong> : <code class="docutils literal notranslate"><span class="pre">post</span></code> 메서드에서 해당 object를 생성합니다.</p></li>
</ul>
<p><strong>GenericAPIView</strong> 는 <code class="docutils literal notranslate"><span class="pre">queryset</span></code>, <code class="docutils literal notranslate"><span class="pre">serializer_class</span></code>, 필요에 따라서는 <code class="docutils literal notranslate"><span class="pre">lookup_field</span></code>, <code class="docutils literal notranslate"><span class="pre">lookup_url_kwarg</span></code> 를 설정하여 사용합니다. 참고자료:<a class="reference external" href="https://github.com/encode/django-rest-framework/blob/master/rest_framework/generics.py">django-rest-framework/generics.py at master · encode/django-rest-framework (github.com)</a></p>
<p>또한 해당 링크에서 <strong>Mixin</strong> 의 소스코드를 볼 수 있습니다. <a class="reference external" href="https://github.com/encode/django-rest-framework/blob/master/rest_framework/mixins.py">django-rest-framework/mixins.py at master · encode/django-rest-framework (github.com)</a></p>
<p><strong>after 3 (generic view 사용)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</pre></div>
</div>
<p><strong>ListCreateAPIView</strong> 제네릭 뷰를 이용하면 그보다 더 간결한 코드가 작성됩니다.<br />
일반적인 목록조회와 객체생성 기능이 손쉽게 가능한 장점이 있지만 기존 코드( <strong>password confirmation</strong> )를 적용하는데 어려움이 있습니다.</p>
<p>따라서 <strong>Mixin</strong> 과 <strong>Generic View</strong> 를 적절히 조합하여 리펙토링을 진행합니다.</p>
<p><strong>after</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    모든 User 목록을 반환하거나, 회원가입을 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="n">password_confirmation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passwordConfirmation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password_confirmation</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">saved_user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">saved_user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="n">saved_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
</pre></div>
</div>
<p>회원가입은 <strong>password confirmation</strong> 과 <strong>password 암호화</strong> 로직을 수행하기 위해 상속받지 않았습니다.</p>
</div>
<div class="section" id="id4">
<h4>프로필 보기, 회원정보 변경, 회원탈퇴<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p><strong>before</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 프로필 보기</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">JSONWebTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 회원정보 변경, 회원탈퇴</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">user_update_delete</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="c1">#1-1. Client에서 온 데이터를 받아서</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
            
        <span class="c1">#1-2. 패스워드 일치 여부 체크</span>
        <span class="k">if</span> <span class="n">old_password</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;이전 비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            
        <span class="c1">#2. UserSerializer를 통해 데이터 직렬화</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1">#3. validation 작업 진행 -&gt; password도 같이 직렬화 진행</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">#4. 비밀번호 해싱 후 </span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">))</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># password는 직렬화 과정에는 포함 되지만 → 표현(response)할 때는 나타나지 않는다.</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;id가 삭제되었습니다&#39;</span><span class="p">})</span><span class="o">.</span>
</pre></div>
</div>
<p>앞서 만들었던 <code class="docutils literal notranslate"><span class="pre">UserList</span></code> 클래스의 경우와 마찬가지로, <strong>CBV</strong> 로 통합하여 <strong>Request Method</strong> 로 구분합니다.</p>
<p><strong>after 1 (APIView 사용)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User의 프로필 보기, 회원정보수정, 회원탈퇴를 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">JSONWebTokenAuthentication</span><span class="p">])</span>
    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_password</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                           <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_password</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    
    <span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">JSONWebTokenAuthentication</span><span class="p">])</span>
    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;사용자가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                           <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; 유저가 삭제되었습니다.&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>여기서는 기존 <code class="docutils literal notranslate"><span class="pre">put</span></code> 메서드를 <code class="docutils literal notranslate"><span class="pre">patch</span></code> 로 변경하였습니다.<br />
현재는 비밀번호 변경 기능밖에 없지만, 추후 email, 이름 데이터 등을 변경할 수 있도록 확장성을 고려해 작성했습니다.</p>
<p>이를 <strong>generic view</strong> 와 <strong>Mixin</strong> 을 이용하여 리펙토링 합니다.</p>
<p><strong>after 1</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
                 <span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User의 프로필 보기, 회원정보수정, 회원탈퇴를 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>

    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;사용자 권한이 없습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_password</span><span class="p">(</span><span class="n">old_password</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">saved_user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_password</span><span class="p">:</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;사용자 권한이 없습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>기존의 <strong>authentication</strong> 데코레이터는 있지만 <strong>authorization</strong> 데코레이터는 없어졌기 때문에 코드의 길이와 가독성이 크게 향상되지는 않았습니다.<br />
그래서 <strong>authorization</strong> 로직을 수행하는 <strong>decorator</strong> 를 만들어서 적용해봅니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># module/custom_decorator.py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="k">def</span> <span class="nf">authorization</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;사용자 권한이 없습니다.&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
<p>이 <strong>decorator</strong> 는 다른 앱에도 사용해야하기 때문에 모듈화 하여 <code class="docutils literal notranslate"><span class="pre">~/module/custom_decorator.py</span></code> 경로에 저장하였습니다. 여기서 <code class="docutils literal notranslate"><span class="pre">~</span></code> 는 <code class="docutils literal notranslate"><span class="pre">manage.py</span></code> 가 있는 경로입니다.</p>
<p>적용이 완료된 코드는 아래와 같습니다.</p>
<p><strong>after</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="n">custom_decorator</span>


<span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
                 <span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User의 프로필 보기, 회원정보수정, 회원탈퇴를 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>

    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="nd">@custom_decorator</span><span class="o">.</span><span class="n">authorization</span>
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_password</span><span class="p">(</span><span class="n">old_password</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">saved_user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_password</span><span class="p">:</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
    <span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="nd">@custom_decorator</span><span class="o">.</span><span class="n">authorization</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>정리<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>이상으로 <code class="docutils literal notranslate"><span class="pre">accounts/</span></code> 앱에 대한 리펙토링을 마쳤습니다. 최대한 객체지향을 생각하며 코드를 작성해보려고 했는데 <strong>DRF</strong> 에 라이브러리에 이미 <strong>Mixin</strong> , <strong>Generic View</strong> 등 많은 기능들이 이미 내장되어있었고, 이를 활용하려다보니 직접 작성한 코드의 비중이 줄었습니다.</p>
<p>또, <strong>객체지향</strong> 보다 <strong>RESTful</strong> 에 더 초첨이 맞춰진 것 같아 아쉬웠습니다.</p>
<p>그래도 <strong>django-rest-framework</strong> 와 <strong>djangorestframework-simplejwt</strong> 의 github 코드를 보며 객체지향적인 코드를 많이 보고 배웠습니다.</p>
<p>다음 포스트에는 영화 데이터를 컨트롤하는 <code class="docutils literal notranslate"><span class="pre">movies</span></code> 앱에 대해 코드 리펙토링을 진행해보겠습니다.</p>
<p>감사합니다.</p>
<div class="section" id="id6">
<h4>참고자료<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://www.django-rest-framework.org/tutorial/3-class-based-views/">3 - Class based views - Django REST framework (django-rest-framework.org)</a></p></li>
<li><p><a class="reference external" href="https://github.com/encode/django-rest-framework/tree/master/rest_framework">django-rest-framework/rest_framework at master · encode/django-rest-framework (github.com)</a></p></li>
<li><p><a class="reference external" href="https://github.com/jazzband/djangorestframework-simplejwt/tree/master/rest_framework_simplejwt">djangorestframework-simplejwt/rest_framework_simplejwt at master · jazzband/djangorestframework-simplejwt (github.com)</a></p></li>
</ul>
</div>
<div class="section" id="id7">
<h4>결과<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>리펙토링 전</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework_jwt.authentication</span> <span class="kn">import</span> <span class="n">JSONWebTokenAuthentication</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">authentication_classes</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">UserSerializer</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">JSONWebTokenAuthentication</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="c1"># 유저정보 가져오기</span>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
	<span class="c1">#1-1. Client에서 온 데이터를 받아서</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">password_confirmation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passwordConfirmation&#39;</span><span class="p">)</span>
		
	<span class="c1">#1-2. 패스워드 일치 여부 체크</span>
    <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password_confirmation</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
		
	<span class="c1">#2. UserSerializer를 통해 데이터 직렬화</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
	<span class="c1">#3. validation 작업 진행 -&gt; password도 같이 직렬화 진행</span>
    <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1">#4. 비밀번호 해싱 후 </span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># password는 직렬화 과정에는 포함 되지만 → 표현(response)할 때는 나타나지 않는다.</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">user_update_delete</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="c1">#1-1. Client에서 온 데이터를 받아서</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
            
        <span class="c1">#1-2. 패스워드 일치 여부 체크</span>
        <span class="k">if</span> <span class="n">old_password</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;이전 비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            
        <span class="c1">#2. UserSerializer를 통해 데이터 직렬화</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1">#3. validation 작업 진행 -&gt; password도 같이 직렬화 진행</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">#4. 비밀번호 해싱 후 </span>
            <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">))</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># password는 직렬화 과정에는 포함 되지만 → 표현(response)할 때는 나타나지 않는다.</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;id가 삭제되었습니다&#39;</span><span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><p>리펙토링 후</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.hashers</span> <span class="kn">import</span> <span class="n">check_password</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span><span class="p">,</span> <span class="n">mixins</span><span class="p">,</span> <span class="n">generics</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">authentication_classes</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">UserSerializer</span>
<span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="n">custom_decorator</span>


<span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    모든 User 목록을 반환하거나, 회원가입을 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="n">password_confirmation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passwordConfirmation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">password_confirmation</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">saved_user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">saved_user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="n">saved_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
                 <span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User의 프로필 보기, 회원정보수정, 회원탈퇴를 합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>

    <span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="nd">@custom_decorator</span><span class="o">.</span><span class="n">authorization</span>
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oldPassword&#39;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;newPassword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_password</span><span class="p">(</span><span class="n">old_password</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;비밀번호가 일치하지 않습니다.&#39;</span><span class="p">},</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">saved_user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_password</span><span class="p">:</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
                <span class="n">saved_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
    <span class="nd">@authentication_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="nd">@custom_decorator</span><span class="o">.</span><span class="n">authorization</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          으로 Jinpyo Hong<br/>
        
            &copy; 저작권 2021, Jinpyo Hong.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>